{% schema %}
{
  "name": "Product Parts Collection",
  "settings": [
    {
      "type": "collection",
      "id": "selected_collection",
      "label": "Select Collection"
    }
  ],
  "blocks": [
    {
      "type": "tab",
      "name": "Tab",
      "settings": [
        {
          "type": "text",
          "id": "text",
          "label": "Tab Text"
        },
        {
          "type": "url",
          "id": "url",
          "label": "Tab Link"
        },
        {
          "type": "checkbox",
          "id": "active",
          "label": "Set as Active"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Product Parts Collection",
      "blocks": [
        { "type": "tab", "settings": { "text": "All", "url": "#", "active": true } },
        { "type": "tab", "settings": { "text": "Range Rover", "url": "#", "active": false } },
        { "type": "tab", "settings": { "text": "Discovery", "url": "#", "active": false } },
        { "type": "tab", "settings": { "text": "Defender", "url": "#", "active": false } }
      ]
    }
  ]
}
{% endschema %}

{% assign collection_handle = section.settings.selected_collection %}
{% assign collection = collections[collection_handle] %}

{% if collection %}
  {% paginate collection.products by 100 %}
<div class="page-width">
  <div class="range-rover-section">

    <!-- Tabs and Sorting -->
    <div class="top-bar-filter desktop-filters">
      <div class="tabs parts-tabs">
        {% for block in section.blocks %}
          {% if block.type == 'tab' %}
            <a href="{{ block.settings.url }}" class="tab {% if block.settings.active %}active{% endif %}">
              {{ block.settings.text }}
            </a>
          {% endif %}
        {% endfor %}
      </div>
      <div class="sort-dropdown">
        <select id="sort_by">
          <option value="">Sort by</option>
          <option value="best-selling">Best Selling</option>
          <option value="price-asc">Price, Low to High</option>
          <option value="price-desc">Price, High to Low</option>
        </select>
      </div>
    </div>

    <!-- Mobile Tabs and Sorting -->
    <div class="top-bar-filter mobile-tablet-filters">
      <div class="dropdwn">
        <select onchange="if (this.value) window.location.href=this.value;">
          {% for block in section.blocks %}
            {% if block.type == 'tab' %}
              <option value="{{ block.settings.url }}" {% if block.settings.active %}selected{% endif %}>
                {{ block.settings.text }}
              </option>
            {% endif %}
          {% endfor %}
        </select>
      </div>
      <div class="sort-dropdown">
        <select id="sort_by">
          <option value="">Sort by</option>
          <option value="best-selling">Best Selling</option>
          <option value="price-asc">Price, Low to High</option>
          <option value="price-desc">Price, High to Low</option>
        </select>
      </div>
    </div>

    <div class="border-lines"></div>

    <!-- Product Grid -->
    {% if collection.products.size > 0 %}
      <div class="main_section_all parts_collections">
        {% for product in collection.products %}
          <div class="content">
            <div class="cards">
              <div class="card">

                <!-- Front Side -->
                <div class="card__side card__side--front card__side--front-1">
                  <div class="product-col-1" data-type="{{ product.type | downcase }}">
                    {% if product.available %}
                      <div class="product-avaliable">Available</div>
                    {% else %}
                      <div class="product-avaliable">Sold</div>
                    {% endif %}

                    <div class="relative_img">
                      <img alt="{{ product.title }}" class="prd-img" src="{{ product.featured_image | img_url: 'large' }}"/>
                      <div class="badge left">{{ collection.title }}</div>
                      <div class="badge rights">
                        <a href="#"><img src="https://cdn.shopify.com/s/files/1/0694/0314/8465/files/Group_620.png?v=1745422926" /></a>
                      </div>
                    </div>

                    <div class="product-col-title">{{ product.title }}</div>
                    <div class="product-details-col product-b-top product-b-bottom">
                      <div class="cl-title">Fact 1</div>
                      <div class="cl-description">
                        {{ product.metafields.custom.fact1 | default: "None" }}
                      </div>
                    </div>
                    <div class="product-details-col product-b-bottom mar-bottom">
                      <div class="cl-title">Fact 2</div>
                      <div class="cl-description">
                        {{ product.metafields.custom.fact2 | default: "None" }}
                      </div>
                    </div>

                    <div class="button-product desktop-section-hide margin-button-bottom">
                      <a href="{{ product.url }}" class="button--main">More info</a>
                    </div>
                  </div>
                </div>

                <!-- Back Side -->
                <div class="card__side card__side--back card__side--back-1">
                  <div class="product-col-2">
                    <div class="product-avaliable">
                      {% if product.available %}
                        <div class="product-avaliable">Available</div>
                      {% else %}
                        <div class="product-avaliable">Sold</div>
                      {% endif %}
                    </div>
                    <div class="relative_img">
                      {% assign second_image = product.images[1] %}
                      <img alt="{{ product.title }}" class="prd-img" src="{{ second_image | default: product.featured_image | img_url: 'large' }}" />
                      <div class="badge right">{{ collection.title }}</div>
                      <div class="badge lefts">
                        <a href="#"><img src="https://cdn.shopify.com/s/files/1/0694/0314/8465/files/Group_620.png?v=1745422926" /></a>
                      </div>
                    </div>
                    <div class="product-col-title white-color">Details</div>
                    <div class="product-details-col product-b-top product-b-bottom white-color">
                      <div class="cl-title white-color">Fact 3</div>
                      <div class="cl-description white-color">
                        {{ product.metafields.custom.fact1 | default: "None" }}
                      </div>
                    </div>
                    <div class="product-details-col product-b-bottom white-color">
                      <div class="cl-title white-color">Fact 4</div>
                      <div class="cl-description white-color">
                        {{ product.metafields.custom.fact2 | default: "None" }}
                      </div>
                    </div>
                    <div class="button-carts-all">
                      <div class="button-product">
                        <a href="{{ product.url }}" class="button--main">View full listing</a>
                      </div>
                      <div class="button-product">
                        <form method="post" action="/cart/add">
                          <input type="hidden" name="id" value="{{ product.variants.first.id }}">
                          <button type="submit" class="button--main cart-button" style="display:none;">Add to cart</button>
                        </form>
                      </div>
                    </div>
                  </div>
                </div>

              </div>
            </div>
          </div>
        {% endfor %}
      </div>

      <div class="border-lines"></div>
      <div class="results-count">Showing {{ collection.products.size }} of {{ collection.products.size }} results</div>
      <div class="border-lines"></div>
    {% else %}
      <p>No products found in this collection.</p>
    {% endif %}

  </div>
</div>
{% endpaginate %}
{% endif %}

<!-- Flip Card Script -->
<script>
document.addEventListener('DOMContentLoaded', function () {
  const flipToBackButtons = document.querySelectorAll('.badge.lefts a');
  const flipToFrontButtons = document.querySelectorAll('.badge.rights a');

  flipToBackButtons.forEach(button => {
    button.addEventListener('click', function (e) {
      e.preventDefault();
      if (window.innerWidth <= 767) {
        const card = this.closest('.card');
        card.classList.remove('frontflipped');
        card.classList.add('flipped');
      }
    });
  });

  flipToFrontButtons.forEach(button => {
    button.addEventListener('click', function (e) {
      e.preventDefault();
      if (window.innerWidth <= 767) {
        const card = this.closest('.card');
        card.classList.remove('flipped');
        card.classList.add('frontflipped');
      }
    });
  });
});
</script>

<!-- Sort by Script -->
<script>
document.addEventListener('DOMContentLoaded', function () {
  const sortSelects = document.querySelectorAll('#sort_by');
  const currentParams = new URLSearchParams(window.location.search);
  const currentSort = currentParams.get('sort_by');

  sortSelects.forEach(select => {
    if (currentSort) {
      select.value = currentSort;
    }

    select.addEventListener('change', function () {
      const selectedSort = this.value;
      const url = new URL(window.location.href);
      url.searchParams.set('sort_by', selectedSort);
      window.location.href = url.toString();
    });
  });
});
</script>
